<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Monitor Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root{
            /* Slightly warmer, softer cream background like the reference */
            --bg: linear-gradient(180deg, #f4f2ec 0%, #fbf7ea 100%);
            /* Warmer golden-yellow accent (higher contrast on white) */
            --accent: #f4c84b; /* main accent */
            --accent-strong: #d79e16; /* darker accent for outlines */
            --card-gap: 8px; /* tighter card spacing */
            --muted: #6e6b66;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 18px;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Header Section */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #333;
            margin-bottom: 18px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .header-left h1 {
            font-size: 2em;
            margin-bottom: 0;
            font-weight: 600;
            color: #333;
        }
        
        .header-left .subtitle {
            font-size: 0.85em;
            opacity: 0.6;
            color: #666;
        }
        
        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .header-icon {
            width: 36px;
            height: 36px;
            background: #f5f3ef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1em;
            color: #666;
        }
        
        .header-icon:hover {
            background: #e8e6e1;
            transform: scale(1.05);
        }
        
        /* Power Cut Alert Banner */
        .power-cut-banner {
            /* make the banner background transparent per user's request */
            background: transparent;
            color: #333;
            border-radius: 12px;
            padding: 10px 16px;
            margin-bottom: 12px;
            box-shadow: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            border-left: 6px solid var(--accent-strong);
        }
        
        .power-cut-banner.no-cuts {
            border-left-color: #51cf66;
        }
        
        .power-cut-main {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .power-cut-icon {
            font-size: 3em;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .power-cut-info h2 {
            font-size: 1.4em;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .power-cut-info p {
            font-size: 0.85em;
            color: #666;
        }
        
        .power-cut-stats {
            display: flex;
            gap: 30px;
        }
        
        .power-cut-stat {
            text-align: center;
        }
        
        .power-cut-stat .value {
            font-size: 1.4em;
            font-weight: 700;
            display: block;
            line-height: 1;
            margin-bottom: 3px;
            color: #333;
        }
        
        .power-cut-stat .label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            background: transparent;
            border-radius: 12px;
            padding: 0;
            display: flex;
            gap: 6px;
            overflow-x: auto;
        }
        
        .nav-tab {
            min-width: auto;
            padding: 10px 20px;
            background: #f5f3ef;
            border: none;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            background: #e8e6e1;
            color: #333;
        }
        
        .nav-tab.active {
            background: var(--accent);
            color: #27241f;
            box-shadow: 0 6px 18px rgba(214,164,62,0.12);
            transform: translateY(-2px);
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--card-gap);
            margin-bottom: 14px;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.96);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 6px 20px rgba(200,170,90,0.04);
            transition: all 0.18s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 12px;
            right: 12px;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--accent-strong));
            transform: scaleX(0);
            transition: transform 0.18s;
            border-radius: 3px;
            opacity: 0.95;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            margin-bottom: 15px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 1.6em;
            font-weight: 700;
            color: #2d2d2d;
            line-height: 1.1;
        }
        
        .stat-value-large {
            font-size: 3.4em;
            font-weight: 800;
            color: #2b2b2b;
            line-height: 1;
            margin-bottom: 6px;
            letter-spacing: -1px;
        }

        /* Small compact card (for min/max voltage, etc) */
        .small-card {
            padding: 8px 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .small-card .label {
            font-size: 0.75em;
            color: var(--muted);
        }

        .small-card .value {
            font-size: 1.1em;
            font-weight: 700;
        }
        
        .stat-label-large {
            font-size: 0.75em;
            color: #999;
            text-transform: none;
            letter-spacing: 0;
            font-weight: 400;
        }
        
        .stat-unit {
            font-size: 0.5em;
            color: #999;
            margin-left: 5px;
            -webkit-text-fill-color: #999;
        }
        
        .stat-subtitle {
            font-size: 0.8em;
            color: #999;
            margin-top: 5px;
        }
        
        /* Chart Containers */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 12px;
            margin-bottom: 18px;
        }

        .main-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 14px;
        }

        .main-card {
            background: rgba(255,255,255,0.98);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 28px rgba(210,170,80,0.04);
            height: 320px; /* increased for bigger visual cards */
            display: flex;
            flex-direction: column;
        }

        .chart-wrapper.small {
            height: 260px; /* increased to match larger cards */
        }
        
        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }
        
        .chart-subtitle {
            font-size: 0.85em;
            color: #999;
        }
        
        .time-toggle {
            background: var(--accent);
            border: none;
            border-radius: 6px;
            padding: 4px 12px;
            font-size: 0.75em;
            font-weight: 600;
            color: #27241f;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-toggle:hover {
            background: var(--accent-strong);
            transform: scale(1.05);
        }
        
        .chart-wrapper {
            position: relative;
            height: 220px;
        }

        /* accent colored small text and key numbers */
        .accent-text { color: var(--accent-strong); font-weight: 700; }

        /* Narrow timeline progress showing gaps during cuts */
        .timeline-progress {
            height: 8px;
            width: 100%;
            border-radius: 6px;
            overflow: hidden;
            background: rgba(0,0,0,0.03);
            margin-top: 10px;
        }

        .timeline-segment {
            display: inline-block;
            height: 100%;
            vertical-align: top;
        }
        
        /* Help Section */
        .help-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .help-section {
            margin-bottom: 30px;
        }
        
        .help-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .help-section p, .help-section ul {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .help-section ul {
            padding-left: 25px;
        }
        
        .help-section li {
            margin-bottom: 8px;
        }
        
        .help-section code {
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .help-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .help-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .help-card p {
            font-size: 0.9em;
            color: #666;
            margin: 0;
        }
        
        /* Footer */
        footer {
            text-align: center;
            color: #999;
            font-size: 0.8em;
            margin-top: 30px;
            padding: 20px;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-left h1 {
                font-size: 1.5em;
            }
            
            .header-right {
                width: 100%;
                flex-wrap: wrap;
            }
            
            .nav-tabs {
                order: -1;
                width: 100%;
            }
            
            .power-cut-banner {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 20px;
            }
            
            .power-cut-stats {
                width: 100%;
                justify-content: space-around;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 10px;
            }
            
            .stat-value {
                font-size: 1.8em;
            }
            
            .stat-value-large {
                font-size: 3em;
            }
            
            .chart-wrapper {
                height: 280px;
            }
            
            .help-content {
                padding: 25px;
            }
        }
        
        .no-data {
            text-align: center;
            padding: 80px 20px;
            color: white;
            font-size: 1.3em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-left">
                <h1>‚ö° Power Monitor</h1>
            </div>
            <div class="header-right">
                <!-- Navigation Tabs in Header -->
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab(event, 'today')">Today</button>
                    <button class="nav-tab" onclick="switchTab(event, '7days')">7 Days</button>
                    <button class="nav-tab" onclick="switchTab(event, '30days')">30 Days</button>
                    <button class="nav-tab" onclick="switchTab(event, '365days')">365 Days</button>
                    <button class="nav-tab" onclick="switchTab(event, 'help')">Help</button>
                </div>
                <div class="header-icon" title="Settings" onclick="window.location.href='admin.cgi'">‚öôÔ∏è</div>
                <div class="header-icon" title="Refresh" onclick="location.reload()">üîÑ</div>
            </div>
        </header>
        
        <!-- Power Cut Alert Banner -->
        <div class="power-cut-banner" id="powerCutBanner">
            <div class="power-cut-main">
                <div class="power-cut-icon" id="powerCutIcon">‚ö†Ô∏è</div>
                <div class="power-cut-info">
                    <h2 id="powerCutTitle">Power Cuts Detected</h2>
                    <p id="powerCutSubtitle">Monitoring power stability across all periods</p>
                </div>
            </div>
            <div class="power-cut-stats">
                <div class="power-cut-stat">
                    <span class="value" id="totalCuts">0</span>
                    <span class="label">Total Cuts</span>
                </div>
                <div class="power-cut-stat">
                    <span class="value" id="totalDuration">0h</span>
                    <span class="label">Total Duration</span>
                </div>
                <div class="power-cut-stat">
                    <span class="value" id="avgDuration">0m</span>
                    <span class="label">Avg Duration</span>
                </div>
            </div>
        </div>
    <!-- narrow timeline progress showing data (gaps for power cuts) -->
    <div class="timeline-progress" id="timelineProgress"></div>

    <!-- Today Tab -->
    <div id="tab-today" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label-large">‚ö° Voltage (Today)</div>
                    <div class="stat-value-large" id="voltage-today">--</div>
                    <div class="small-card" style="margin-top:6px;">
                        <div>
                            <div class="label">Min</div>
                            <div class="value" id="voltageMinToday">-- V</div>
                        </div>
                        <div>
                            <div class="label">Max</div>
                            <div class="value" id="voltageMaxToday">-- V</div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-label-large">üí° kWh (Today)</div>
                    <div class="stat-value-large" id="kwh-today">--</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label-large">‚ö†Ô∏è Power Cuts (Today)</div>
                    <div class="stat-value-large" id="cuts-today" style="color: #ff6b6b;">0</div>
                    <div class="stat-subtitle" id="cutsTodayDuration">0 hours</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-label">Current Power</div>
                    <div class="stat-value" id="current-today">-- <span class="stat-unit">W</span></div>
                </div>
            </div>

            <div class="main-cards">
                <div class="main-card">
                    <div class="chart-header">
                        <div class="chart-title">Real-time Voltage</div>
                        <button class="time-toggle" onclick="toggleTodayTimeRange(this, 'voltageChartToday')" data-range="10">10h</button>
                    </div>
                    <div class="chart-wrapper small"><canvas id="voltageChartToday"></canvas></div>
                </div>

                <div class="main-card">
                    <div class="chart-header">
                        <div class="chart-title">Hourly Energy</div>
                        <button class="time-toggle" onclick="toggleTodayTimeRange(this, 'hourlyEnergyChartToday')" data-range="10">10h</button>
                    </div>
                    <div class="chart-wrapper small"><canvas id="hourlyEnergyChartToday"></canvas></div>
                </div>

                <div class="main-card">
                    <div class="chart-header">
                        <div class="chart-title">Live Power</div>
                        <button class="time-toggle" onclick="toggleTodayTimeRange(this, 'livePowerChartToday')" data-range="10">10h</button>
                    </div>
                    <div class="chart-wrapper small"><canvas id="livePowerChartToday"></canvas></div>
                </div>

                <div class="main-card">
                    <div class="chart-header">
                        <div class="chart-title">Power Factor</div>
                        <button class="time-toggle" onclick="toggleTodayTimeRange(this, 'powerFactorChartToday')" data-range="10">10h</button>
                    </div>
                    <div class="chart-wrapper small"><canvas id="powerFactorChartToday"></canvas></div>
                </div>
            </div>
        </div>

        <!-- 7 Days Tab -->
        <div id="tab-7days" class="tab-content">
            <div class="stats-grid">
                <!-- Large Number Cards -->
                <div class="stat-card">
                    <div class="stat-label-large">‚ö° Voltage</div>
                    <div class="stat-value-large" id="voltage-7">
                        {{ "%.0f"|format(statistics.current / 2) }}
                    </div>
                    <div class="small-card" style="margin-top:6px;">
                        <div>
                            <div class="label">Min</div>
                            <div class="value" id="voltageMin">-- V</div>
                        </div>
                        <div>
                            <div class="label">Max</div>
                            <div class="value" id="voltageMax">-- V</div>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label-large">üí° Total kWh</div>
                    <div class="stat-value-large" id="total-kwh-large">
                        {{ "%.0f"|format(statistics.total_kwh) }}
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label-large">‚ö†Ô∏è Power Cuts</div>
                    <div class="stat-value-large" id="cuts-large" style="color: #ff6b6b;">
                        <span id="cuts7Count">0</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-label">Current Power</div>
                    <div class="stat-value" id="current-7">
                        {{ "%.1f"|format(statistics.current) }}
                        <span class="stat-unit">W</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">Average</div>
                    <div class="stat-value" id="avg-7">
                        {{ "%.1f"|format(statistics.average) }}
                        <span class="stat-unit">W</span>
                    </div>
                    <div class="stat-subtitle">Last 7 days</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìâ</div>
                    <div class="stat-label">Minimum</div>
                    <div class="stat-value" id="min-7">
                        {{ "%.1f"|format(statistics.min) }}
                        <span class="stat-unit">W</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-label">Maximum</div>
                    <div class="stat-value" id="max-7">
                        {{ "%.1f"|format(statistics.max) }}
                        <span class="stat-unit">W</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üí°</div>
                    <div class="stat-label">Total Energy</div>
                    <div class="stat-value" id="total-7">
                        {{ "%.2f"|format(statistics.total_kwh) }}
                        <span class="stat-unit">kWh</span>
                    </div>
                    <div class="stat-subtitle">Last 7 days</div>
                </div>
                
                <!-- Data Points card removed as requested -->
            </div>
            
            <div class="main-cards">
                <div class="main-card">
                    <div class="chart-header">
                        <div class="chart-title">Real-time Voltage</div>
                        <div class="chart-subtitle">Line</div>
                    </div>
                    <div class="chart-wrapper small"><canvas id="voltageChart"></canvas></div>
                </div>

                <div class="main-card">
                    <div class="chart-header">
                        <div class="chart-title">Hourly Energy</div>
                        <div class="chart-subtitle">Narrow bar</div>
                    </div>
                    <div class="chart-wrapper small"><canvas id="hourlyEnergyChart"></canvas></div>
                </div>

                <div class="main-card">
                    <div class="chart-header">
                        <div class="chart-title">Live Power</div>
                        <div class="chart-subtitle">Line</div>
                    </div>
                    <div class="chart-wrapper small"><canvas id="livePowerChart"></canvas></div>
                </div>

                <div class="main-card">
                    <div class="chart-header">
                        <div class="chart-title">Power Factor</div>
                        <div class="chart-subtitle">Line</div>
                    </div>
                    <div class="chart-wrapper small"><canvas id="powerFactorChart"></canvas></div>
                </div>
            </div>
        </div>
        
        <!-- 30 Days Tab -->
        <div id="tab-30days" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">Average (30d)</div>
                    <div class="stat-value" id="avg-30">
                        {{ "%.1f"|format(statistics.average) }}
                        <span class="stat-unit">W</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üí°</div>
                    <div class="stat-label">Total Energy (30d)</div>
                    <div class="stat-value" id="total-30">
                        {{ "%.2f"|format(statistics.total_kwh * 4.3) }}
                        <span class="stat-unit">kWh</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-label">Power Cuts (30d)</div>
                    <div class="stat-value" id="cuts-30" style="-webkit-text-fill-color: #ff6b6b;">
                        <span id="cuts30Count">0</span>
                    </div>
                    <div class="stat-subtitle" id="cuts30Duration">0 hours total</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-label">Peak Usage</div>
                    <div class="stat-value" id="peak-30">
                        {{ "%.1f"|format(statistics.max) }}
                        <span class="stat-unit">W</span>
                    </div>
                </div>
            </div>
            
            <div class="charts-row">
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">30-Day Trend</div>
                            <div class="chart-subtitle">Daily average consumption</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart30"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="help-content">
                <h3>üìä 30-Day Analysis</h3>
                <p>The 30-day view provides insights into your monthly power consumption patterns. Use this data to identify trends and optimize energy usage.</p>
                <div class="help-grid">
                    <div class="help-card">
                        <h4>Monthly Patterns</h4>
                        <p>Track consumption changes across weeks to identify seasonal variations.</p>
                    </div>
                    <div class="help-card">
                        <h4>Power Cuts Impact</h4>
                        <p>View how power interruptions affect your monthly reliability.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 365 Days Tab -->
        <div id="tab-365days" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">Average (365d)</div>
                    <div class="stat-value" id="avg-365">
                        {{ "%.1f"|format(statistics.average) }}
                        <span class="stat-unit">W</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üí°</div>
                    <div class="stat-label">Total Energy (365d)</div>
                    <div class="stat-value" id="total-365">
                        {{ "%.2f"|format(statistics.total_kwh * 52.14) }}
                        <span class="stat-unit">kWh</span>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-label">Power Cuts (365d)</div>
                    <div class="stat-value" id="cuts-365" style="-webkit-text-fill-color: #ff6b6b;">
                        <span id="cuts365Count">0</span>
                    </div>
                    <div class="stat-subtitle" id="cuts365Duration">0 hours total</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-label">Est. Annual Cost</div>
                    <div class="stat-value" id="cost-365">
                        $<span>{{ "%.0f"|format(statistics.total_kwh * 52.14 * 0.12) }}</span>
                    </div>
                    <div class="stat-subtitle">@ $0.12/kWh</div>
                </div>
            </div>
            
            <div class="charts-row">
                <div class="chart-card" style="grid-column: 1 / -1;">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Annual Overview</div>
                            <div class="chart-subtitle">Monthly consumption patterns</div>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="chart365"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="help-content">
                <h3>üìà Annual Insights</h3>
                <p>The yearly view helps you understand long-term consumption trends and seasonal variations in your power usage.</p>
                <div class="help-grid">
                    <div class="help-card">
                        <h4>Seasonal Trends</h4>
                        <p>Identify how weather and seasons affect your consumption.</p>
                    </div>
                    <div class="help-card">
                        <h4>Year-over-Year</h4>
                        <p>Compare usage across years to track efficiency improvements.</p>
                    </div>
                    <div class="help-card">
                        <h4>Reliability Metrics</h4>
                        <p>Annual power cut statistics help evaluate grid stability.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help Tab -->
        <div id="tab-help" class="tab-content">
            <div class="help-content">
                <h3>üí° About This Dashboard</h3>
                <p>Welcome to your Power Monitoring Dashboard! This system tracks your power consumption in real-time and provides comprehensive analytics to help you understand your energy usage patterns.</p>
                
                <div class="help-section">
                    <h3>üìä Understanding the Metrics</h3>
                    <ul>
                        <li><strong>Current Power:</strong> Real-time power consumption in Watts (W)</li>
                        <li><strong>Average:</strong> Mean power consumption over the selected time period</li>
                        <li><strong>Minimum/Maximum:</strong> Lowest and highest recorded power levels</li>
                        <li><strong>Total Energy:</strong> Cumulative energy consumption in kilowatt-hours (kWh)</li>
                        <li><strong>Power Cuts:</strong> Detected outages when consumption drops to 0W for extended periods</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>‚ö†Ô∏è Power Cut Detection</h3>
                    <p>The system automatically detects power cuts by identifying periods where consumption drops to zero. The banner at the top shows:</p>
                    <ul>
                        <li><strong>Total Cuts:</strong> Number of power interruptions detected</li>
                        <li><strong>Total Duration:</strong> Combined length of all outages</li>
                        <li><strong>Average Duration:</strong> Typical length of a power cut</li>
                    </ul>
                    <p>Each tab view (7/30/365 days) also displays period-specific power cut statistics.</p>
                </div>
                
                <div class="help-section">
                    <h3>üîç Time Periods</h3>
                    <ul>
                        <li><strong>7 Days:</strong> Detailed hourly view showing recent consumption patterns</li>
                        <li><strong>30 Days:</strong> Daily averages revealing weekly and monthly trends</li>
                        <li><strong>365 Days:</strong> Monthly overview for annual planning and cost estimation</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>üìà Chart Interactions</h3>
                    <ul>
                        <li>Hover over data points to see exact values and timestamps</li>
                        <li>Charts automatically update when new data is collected</li>
                        <li>Power cut periods may appear as gaps or zero values in the timeline</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>‚öôÔ∏è System Administration</h3>
                    <ul>
                        <li>Click the ‚öôÔ∏è icon to access the admin panel</li>
                        <li>Use the üîÑ icon to manually refresh the dashboard</li>
                        <li>Admin panel allows you to toggle maintenance mode and trigger manual syncs</li>
                    </ul>
                </div>
                
                <div class="help-grid">
                    <div class="help-card">
                        <h4>üîí Security</h4>
                        <p>Your data is stored locally and optionally published to your private GitHub repository. No third-party services have access to your consumption data.</p>
                    </div>
                    <div class="help-card">
                        <h4>üîÑ Data Updates</h4>
                        <p>The system collects data every 10 minutes from your Home Assistant instance. Charts update automatically after each collection cycle.</p>
                    </div>
                    <div class="help-card">
                        <h4>üíæ Data Retention</h4>
                        <p>By default, the system retains 7 days of detailed data. Older data is automatically pruned to save storage space.</p>
                    </div>
                    <div class="help-card">
                        <h4>üì± Mobile Access</h4>
                        <p>This dashboard is fully responsive and works great on mobile devices. Access it from anywhere on your local network.</p>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>üõ†Ô∏è Troubleshooting</h3>
                    <ul>
                        <li><strong>No data showing:</strong> Verify Home Assistant is accessible and the entity ID is correct</li>
                        <li><strong>Data not updating:</strong> Check that cron jobs are running and maintenance mode is off</li>
                        <li><strong>Power cuts not detected:</strong> System identifies cuts when consumption = 0W for 5+ minutes</li>
                        <li><strong>Admin panel not working:</strong> Ensure CGI is enabled and scripts have execute permissions</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h3>üìû Support</h3>
                    <p>For issues or questions:</p>
                    <ul>
                        <li>Check the logs in <code>/var/log/power-monitor-*.log</code></li>
                        <li>Review the project documentation in the GitHub repository</li>
                        <li>Verify configuration in <code>/opt/power-monitor/config.json</code></li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer>
            <p>Last updated: {{ last_update }} | Generated: {{ generation_time }}</p>
            <p>Power Monitoring System v2.0 | Data retention: 7 days</p>
        </footer>
    </div>
    
    <script>
        // Data stores - will be loaded dynamically
        let dataPoints = [];
        let todayPoints = [];
        let weeklyData = [];
        let monthlyData = [];
        let yearlyData = [];
        
        // Data source mapping for each tab (use lowercase keys to match nav buttons)
        const DATA_SOURCES = {
            'today': 'daily.json',
            '7days': 'weekly.json',
            '30days': 'monthly.json',
            '365days': 'yearly.json'
        };
        
        // Current active tab
        let currentTab = 'Today';
        
        // Fetch JSON data from server
        async function loadDataForTab(tabName) {
            const filename = DATA_SOURCES[tabName];
            if (!filename) {
                console.error('Unknown tab:', tabName);
                return null;
            }
            
            try {
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const json = await response.json();
                return json.data_points || [];
            } catch (error) {
                console.error(`Failed to load ${filename}:`, error);
                return null;
            }
        }
        
        // Initialize dashboard with data from specific tab
        async function initializeDashboard(tabName) {
            currentTab = tabName;
            const data = await loadDataForTab(tabName);
            
            if (!data || data.length === 0) {
                document.querySelector('.container').innerHTML = 
                    '<div class="no-data">‚è≥ No data available yet<br><br>Data collection in progress...<br>Please check back in a few minutes.</div>';
                return;
            }
            
            // Update global data based on tab
            const tn = tabName.toLowerCase();
            if (tn === 'today') {
                todayPoints = data;
                dataPoints = data;
                initTodayCharts();
            } else if (tn === '7days') {
                dataPoints = data;
                weeklyData = data;
                render7DaysCharts();
            } else if (tn === '30days') {
                monthlyData = data;
                render30DaysChart();
            } else if (tn === '365days') {
                yearlyData = data;
                render365DaysChart();
            }

            // Update power cut banner (use appropriate dataset)
            const bannerData = (tabName.toLowerCase() === 'today') ? todayPoints : dataPoints;
            const allCuts = detectPowerCuts(bannerData);
            updatePowerCutBanner(allCuts);
        }
        
        // Tab switching function
        async function switchTab(event, tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab (guard existence)
            const selected = document.getElementById('tab-' + tabName);
            if (selected) selected.classList.add('active');
            else console.warn('Tab not found:', tabName);
            
            // Highlight active nav tab
            if (event && event.target) event.target.classList.add('active');
            
            // Load data for the new tab
            await initializeDashboard(tabName);
        }
        
        // Power cut detection function
        function detectPowerCuts(data, periodDays = 7) {
            const cuts = [];
            let cutStart = null;
            
            for (let i = 0; i < data.length; i++) {
                const point = data[i];
                const value = point.value;
                
                if (value === 0 || value < 1) {
                    if (cutStart === null) {
                        cutStart = i;
                    }
                } else {
                    if (cutStart !== null) {
                        const duration = i - cutStart;
                        if (duration >= 1) { // At least 1 data point (10 minutes)
                            cuts.push({
                                start: data[cutStart].timestamp,
                                end: data[i - 1].timestamp,
                                duration: duration * 10 // minutes (assuming 10-min intervals)
                            });
                        }
                        cutStart = null;
                    }
                }
            }
            
            // Handle ongoing cut
            if (cutStart !== null && data.length - cutStart >= 1) {
                cuts.push({
                    start: data[cutStart].timestamp,
                    end: data[data.length - 1].timestamp,
                    duration: (data.length - cutStart) * 10
                });
            }
            
            return cuts;
        }
        
        // Update power cut banner
        function updatePowerCutBanner(cuts) {
            const banner = document.getElementById('powerCutBanner');
            const icon = document.getElementById('powerCutIcon');
            const title = document.getElementById('powerCutTitle');
            const subtitle = document.getElementById('powerCutSubtitle');
            
            const totalCuts = cuts.length;
            const totalMinutes = cuts.reduce((sum, cut) => sum + cut.duration, 0);
            const totalHours = (totalMinutes / 60).toFixed(1);
            const avgMinutes = totalCuts > 0 ? Math.round(totalMinutes / totalCuts) : 0;
            
            document.getElementById('totalCuts').textContent = totalCuts;
            document.getElementById('totalDuration').textContent = totalHours + 'h';
            document.getElementById('avgDuration').textContent = avgMinutes + 'm';
            
            if (totalCuts === 0) {
                banner.classList.add('no-cuts');
                icon.textContent = '‚úÖ';
                title.textContent = 'No Power Cuts Detected';
                subtitle.textContent = 'Power supply has been stable';
            } else {
                banner.classList.remove('no-cuts');
                icon.textContent = '‚ö†Ô∏è';
                title.textContent = totalCuts + ' Power Cut' + (totalCuts > 1 ? 's' : '') + ' Detected';
                subtitle.textContent = 'Total downtime: ' + totalHours + ' hours across all periods';
            }
        }
        
        // Render 7 Days charts
        function render7DaysCharts() {
            if (!dataPoints || dataPoints.length === 0) {
                console.warn('No data for 7 Days view');
                return;
            }
            
            // Detect power cuts
            const allCuts = detectPowerCuts(dataPoints);
            updatePowerCutBanner(allCuts);
            
            // Update period-specific cut stats
            document.getElementById('cuts7Count').textContent = allCuts.length;
            const cuts7Hours = (allCuts.reduce((sum, cut) => sum + cut.duration, 0) / 60).toFixed(1);
            const cuts7DurEl = document.getElementById('cuts7Duration');
            if (cuts7DurEl) cuts7DurEl.textContent = cuts7Hours + ' hours downtime';
            
            // Update data point count (guarded - element may have been removed)
            const dpEl = document.getElementById('dataPointCount');
            if (dpEl) dpEl.textContent = dataPoints.length;
            
            // 30-day estimates (multiply by ~4.3)
            const cuts30Est = Math.round(allCuts.length * 4.3);
            const cuts30Hours = (cuts7Hours * 4.3).toFixed(1);
            document.getElementById('cuts30Count').textContent = cuts30Est;
            document.getElementById('cuts30Duration').textContent = cuts30Hours + ' hours total';
            
            // 365-day estimates (multiply by ~52)
            const cuts365Est = Math.round(allCuts.length * 52);
            const cuts365Hours = (cuts7Hours * 52).toFixed(1);
            document.getElementById('cuts365Count').textContent = cuts365Est;
            document.getElementById('cuts365Duration').textContent = cuts365Hours + ' hours total';
            
            // Prepare chart data
            const chartData = dataPoints.map(dp => ({
                x: new Date(dp.timestamp),
                y: dp.value
            }));
            
            // Common chart options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            };
            
            // 7-Day Power Chart
            new Chart(document.getElementById('powerChart7'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Power (W)',
                        data: chartData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        pointHoverBackgroundColor: '#667eea',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return 'Power: ' + context.parsed.y.toFixed(1) + ' W';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MMM dd HH:mm'
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
            // Calculate daily averages
            const dailyData = {};
            dataPoints.forEach(dp => {
                const date = new Date(dp.timestamp).toISOString().split('T')[0];
                if (!dailyData[date]) {
                    dailyData[date] = { sum: 0, count: 0 };
                }
                dailyData[date].sum += dp.value;
                dailyData[date].count += 1;
            });
            
            const dailyAverages = Object.entries(dailyData).map(([date, data]) => ({
                x: date,
                y: data.sum / data.count
            }));
            
            // --- Main charts for the new layout ---
            // Helper: format numbers
            function fmt(n) {
                return Number(n).toLocaleString();
            }

            // Function to toggle between 10hr and 24hr view for Today charts
            function toggleTodayTimeRange(button, chartId) {
                const currentRange = button.getAttribute('data-range');
                const newRange = currentRange === '10' ? '24' : '10';
                button.setAttribute('data-range', newRange);
                button.textContent = newRange + 'h';
                
                // Re-render the specific chart with new time range
                renderTodayChart(chartId, parseInt(newRange));
            }
            
            // Render a specific Today chart with given time range (hours)
            function renderTodayChart(chartId, hours) {
                const srcPoints = (todayPoints && todayPoints.length) ? todayPoints : [];
                if (!srcPoints.length) return;
                
                const now = new Date();
                const cutoff = new Date(now.getTime() - hours * 3600000);
                const filtered = srcPoints.filter(dp => new Date(dp.timestamp) >= cutoff);
                
                const series = filtered.map(dp => ({ x: new Date(dp.timestamp), y: dp.value }));
                const avgVal = series.reduce((s,p)=>s+p.y,0)/Math.max(1, series.length);
                
                let chartData, chartType = 'line', chartOptions = { ...commonOptions, scales: { x: { type: 'time', time: { unit: 'hour' } }, y: {} } };
                
                if (chartId === 'voltageChartToday') {
                    chartData = series.map((pt, idx) => {
                        const v = 230 + ((pt.y - avgVal) / Math.max(1, avgVal)) * 5 + Math.sin(idx/10) * 0.5;
                        return { x: pt.x, y: Number(v.toFixed(2)) };
                    });
                } else if (chartId === 'hourlyEnergyChartToday') {
                    const hourlyMap = {};
                    filtered.forEach(dp => {
                        const d = new Date(dp.timestamp);
                        const key = d.toISOString().slice(0,13) + ':00:00Z';
                        hourlyMap[key] = (hourlyMap[key]||0) + (dp.value / 6000.0);
                    });
                    chartData = Object.entries(hourlyMap).map(([k,v]) => ({ x: new Date(k), y: Number(v.toFixed(3)) }));
                    chartType = 'bar';
                } else if (chartId === 'livePowerChartToday') {
                    chartData = series;
                } else if (chartId === 'powerFactorChartToday') {
                    chartData = series.map((pt, idx) => {
                        const pf = 0.95 + ((pt.y - avgVal) / Math.max(1, avgVal)) * 0.02 + Math.cos(idx/15) * 0.005;
                        return { x: pt.x, y: Number(Math.max(0.6, Math.min(1.0, pf)).toFixed(3)) };
                    });
                    chartOptions.scales.y.min = 0.6;
                    chartOptions.scales.y.max = 1.0;
                }
                
                const canvasEl = document.getElementById(chartId);
                if (canvasEl) {
                    const chartKey = 'chart_' + chartId;
                    if (window[chartKey]) try { window[chartKey].destroy(); } catch(e){}
                    window[chartKey] = new Chart(canvasEl, {
                        type: chartType,
                        data: { datasets: [{ data: chartData, borderColor: 'rgba(246,200,76,1)', backgroundColor: 'rgba(246,200,76,0.12)', tension: 0.3, pointRadius: 0 }] },
                        options: chartOptions
                    });
                }
            }
            
            // Initialize all Today charts
            function initTodayCharts() {
                const srcPoints = (todayPoints && todayPoints.length) ? todayPoints : [];
                if (!srcPoints.length) return;
                
                // Update summary stats
                const kwhToday = srcPoints.reduce((s, p) => s + (p.value / 6000.0), 0);
                const kwhEl = document.getElementById('kwh-today');
                if (kwhEl) kwhEl.textContent = kwhToday.toFixed(2);
                
                const todayCuts = detectPowerCuts(srcPoints);
                const cutsEl = document.getElementById('cuts-today');
                if (cutsEl) cutsEl.textContent = todayCuts.length;
                const cutsDurEl = document.getElementById('cutsTodayDuration');
                if (cutsDurEl) cutsDurEl.textContent = ((todayCuts.reduce((s,c)=>s+c.duration,0)/60).toFixed(1)) + ' hours';
                
                const curEl = document.getElementById('current-today');
                if (curEl && srcPoints.length) curEl.innerHTML = srcPoints[srcPoints.length-1].value.toFixed(1) + ' <span class="stat-unit">W</span>';
                
                // Voltage stats
                if (srcPoints.length) {
                    const avgP = srcPoints.reduce((s,p)=>s+p.value,0)/srcPoints.length;
                    const voltSeries = srcPoints.map((pt, idx) => {
                        const v = 230 + ((pt.value - avgP) / Math.max(1, avgP)) * 5 + Math.sin(idx/10) * 0.5;
                        return { x: new Date(pt.timestamp), y: Number(v.toFixed(2)) };
                    });
                    const vMinEl = document.getElementById('voltageMinToday'); 
                    if (vMinEl) vMinEl.textContent = Math.min(...voltSeries.map(v=>v.y)).toFixed(1) + ' V';
                    const vMaxEl = document.getElementById('voltageMaxToday'); 
                    if (vMaxEl) vMaxEl.textContent = Math.max(...voltSeries.map(v=>v.y)).toFixed(1) + ' V';
                    const vNowEl = document.getElementById('voltage-today'); 
                    if (vNowEl) vNowEl.textContent = Math.round(voltSeries[voltSeries.length-1].y);
                }
                
                // Render all four main charts (default: last 10 hours)
                renderTodayChart('voltageChartToday', 10);
                renderTodayChart('hourlyEnergyChartToday', 10);
                renderTodayChart('livePowerChartToday', 10);
                renderTodayChart('powerFactorChartToday', 10);
            }



            const avgPower = chartData.reduce((s,p)=>s+p.y,0)/chartData.length;

            // Voltage series (simulated from power values)
            const voltageSeries = chartData.map((pt, idx) => {
                // small deterministic variation based on index
                const v = 230 + ((pt.y - avgPower) / Math.max(1, avgPower)) * 5 + Math.sin(idx/10) * 0.5;
                return { x: pt.x, y: Number(v.toFixed(2)) };
            });

            // Power factor series (simulated)
            const pfSeries = chartData.map((pt, idx) => {
                const pf = 0.95 + ((pt.y - avgPower) / Math.max(1, avgPower)) * 0.02 + Math.cos(idx/15) * 0.005;
                return { x: pt.x, y: Number(Math.max(0.6, Math.min(1.0, pf)).toFixed(3)) };
            });

            // Hourly energy aggregation (kWh)
            const hourlyMap = {};
            dataPoints.forEach(dp => {
                const d = new Date(dp.timestamp);
                const key = d.toISOString().slice(0,13) + ':00:00Z'; // hourly key
                const kh = dp.value / 6000.0; // kWh per 10-min point (value*(10/60)/1000)
                hourlyMap[key] = (hourlyMap[key]||0) + kh;
            });
            const hourlySeries = Object.entries(hourlyMap).map(([k,v]) => ({ x: new Date(k), y: Number(v.toFixed(3)) }));

            // Live power chart (reuse chartData but show last 48 points)
            const liveData = chartData.slice(-48);

            // Render timeline segments (compact progress with gaps for cuts)
            function renderTimelineSegments(data) {
                const container = document.getElementById('timelineProgress');
                container.innerHTML = '';
                const segments = Math.min(240, data.length);
                const segSize = Math.ceil(data.length / segments);
                for (let s=0; s<segments; s++) {
                    const start = s*segSize;
                    const end = Math.min(data.length, start+segSize);
                    let hasPower = false;
                    for (let i=start;i<end;i++) {
                        if (data[i].value > 1) { hasPower = true; break; }
                    }
                    const seg = document.createElement('div');
                    seg.className = 'timeline-segment';
                    seg.style.width = (100/segments) + '%';
                    seg.style.background = hasPower ? 'var(--accent)' : 'transparent';
                    container.appendChild(seg);
                }
            }

            renderTimelineSegments(dataPoints);

            // Voltage chart
            new Chart(document.getElementById('voltageChart'), {
                type: 'line',
                data: { datasets: [{ data: voltageSeries, borderColor: 'rgba(246,200,76,1)', backgroundColor: 'rgba(246,200,76,0.12)', tension: 0.3, pointRadius: 0 }] },
                options: { ...commonOptions, scales: { x: { type: 'time', time: { unit: 'hour' } }, y: { title: { display: true, text: 'Voltage (V)' } } } }
            });

            // Hourly energy narrow bar chart
            new Chart(document.getElementById('hourlyEnergyChart'), {
                type: 'bar',
                data: { datasets: [{ data: hourlySeries, backgroundColor: 'rgba(246,200,76,0.9)', barThickness: 'flex' }] },
                options: { ...commonOptions, scales: { x: { type: 'time', time: { unit: 'hour' } }, y: { title: { display: true, text: 'kWh' } } } }
            });

            // Live power (last 8 hours)
            new Chart(document.getElementById('livePowerChart'), {
                type: 'line',
                data: { datasets: [{ data: liveData, borderColor: 'rgba(246,200,76,1)', backgroundColor: 'rgba(246,200,76,0.08)', tension: 0.35, pointRadius: 0 }] },
                options: { ...commonOptions, scales: { x: { type: 'time', time: { unit: 'hour' } }, y: { title: { display: true, text: 'Power (W)' } } } }
            });

            // Power factor chart
            new Chart(document.getElementById('powerFactorChart'), {
                type: 'line',
                data: { datasets: [{ data: pfSeries, borderColor: 'rgba(120,120,120,1)', backgroundColor: 'rgba(120,120,120,0.06)', tension: 0.3, pointRadius: 0 }] },
                options: { ...commonOptions, scales: { x: { type: 'time', time: { unit: 'hour' } }, y: { title: { display: true, text: 'Power Factor' }, min: 0.6, max: 1.0 } } }
            });

            // Populate small stats: voltage min/max and total kWh
            const voltValues = voltageSeries.map(v=>v.y);
            const vMin = Math.min(...voltValues).toFixed(1);
            const vMax = Math.max(...voltValues).toFixed(1);
            document.getElementById('voltage-7').textContent = Math.round(voltageSeries[voltageSeries.length-1].y);
            // create or set min/max elements if present
            const vmEl = document.getElementById('voltageMin'); if (vmEl) vmEl.textContent = vMin + ' V';
            const vMEl = document.getElementById('voltageMax'); if (vMEl) vMEl.textContent = vMax + ' V';
        }
        
        // Render 30 Days chart
        function render30DaysChart() {
            if (!monthlyData || monthlyData.length === 0) {
                console.warn('No data for 30 Days view');
                return;
            }
            
            // Monthly data should already be daily averages from aggregator
            const dailyAverages = monthlyData.map(dp => ({
                x: dp.timestamp,
                y: dp.value
            }));
            
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            };
            
            // 30-Day Chart (using daily averages)
            new Chart(document.getElementById('chart30'), {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Daily Average (W)',
                        data: dailyAverages,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return 'Average: ' + context.parsed.y.toFixed(1) + ' W';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        // Render 365 Days chart
        function render365DaysChart() {
            if (!yearlyData || yearlyData.length === 0) {
                console.warn('No data for 365 Days view');
                return;
            }
            
            // Yearly data should already be daily averages from aggregator
            // Aggregate to monthly for display
            const monthlyDataMap = {};
            yearlyData.forEach(dp => {
                const date = new Date(dp.timestamp);
                const month = date.toISOString().substring(0, 7); // YYYY-MM
                if (!monthlyDataMap[month]) {
                    monthlyDataMap[month] = { sum: 0, count: 0 };
                }
                monthlyDataMap[month].sum += dp.value;
                monthlyDataMap[month].count += 1;
            });
            
            const monthlyAverages = Object.entries(monthlyDataMap).map(([month, data]) => ({
                x: month + '-01',
                y: data.sum / data.count
            }));
            
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            };
            
            new Chart(document.getElementById('chart365'), {
                type: 'bar',
                data: {
                    datasets: [{
                        label: 'Monthly Average (W)',
                        data: monthlyAverages,
                        backgroundColor: 'rgba(118, 75, 162, 0.7)',
                        borderColor: '#764ba2',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return 'Monthly Avg: ' + context.parsed.y.toFixed(1) + ' W';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM yyyy'
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        // Page load - initialize with today tab
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeDashboard('today');
        });
    </script>
</body>
</html>
